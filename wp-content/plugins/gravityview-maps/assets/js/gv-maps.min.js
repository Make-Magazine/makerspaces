window.GV_MAPS=window.GV_MAPS||{},function($){"use strict";var self=$.extend({didScroll:!1,mapOffset:0,mapStickyContainer:null,mapEntriesContainerClass:".gv-map-entries",markers:[],is_single_entry:!1},GV_MAPS),maps=[],bounds=new google.maps.LatLngBounds,infowindow=new google.maps.InfoWindow({content:"",maxWidth:parseInt(self.infowindow.max_width,10)});self.init=function(){var first_map=document.getElementById(self.map_id_prefix+"-0");null!==first_map&&($(".gv-map-single-container").length>0&&(self.is_single_entry=!0),self.multiple_maps=parseInt(self.multiple_maps,10),self.prepareStickyCanvas(),self.setupMaps(),self.processMarkers(),self.initMobile(),self.startScrollCheck(),self.initAnimateMarkers())},self.setupMaps=function(){var m;self.MapOptions.zoom=parseInt(self.MapOptions.zoom,10),self.MapOptions.mapTypeId=google.maps.MapTypeId[self.MapOptions.mapTypeId],self.MapOptions.zoomControl&&(self.MapOptions.zoomControlOptions=self.zoomControlOptions());for(var map_element,i=0;i<=self.multiple_maps;i++)if(map_element=document.getElementById(self.map_id_prefix+"-"+i.toString()),null!==map_element){var trafficLayer=new google.maps.TrafficLayer,transitLayer=new google.maps.TransitLayer,bicyclingLayer=new google.maps.BicyclingLayer;m=new google.maps.Map(map_element,self.MapOptions),1===self.layers.bicycling&&bicyclingLayer.setMap(m),1===self.layers.transit&&transitLayer.setMap(m),1===self.layers.traffic&&trafficLayer.setMap(m),maps.push(m),self.setZoom(m)}else console&&console.error("GravityView map DOM element not found at #"+self.map_id_prefix+"-"+i.toString()+"; map not created.")},self.setZoom=function(map){google.maps.event.addListenerOnce(map,"idle",function(){map.getZoom()>self.MapOptions.zoom&&map.setZoom(self.MapOptions.zoom)})},self.processMarkers=function(){for(var i in self.markers_info)maps.forEach(self.add_marker,self.markers_info[i])},self.add_marker=function(map,i,array){var entryID=document.getElementById(self.map_id_prefix+"-"+i.toString()).getAttribute("data-entryid");if(!entryID||entryID==this.entry_id){var geo=new google.maps.LatLng(this.lat,this["long"]),icon=this.icon_url||self.icon,marker=new google.maps.Marker({map:map,icon:icon,url:this.url,position:geo,entryId:this.entry_id,content:this.content});entryID?maps[i].fitBounds((new google.maps.LatLngBounds).extend(marker.position)):(bounds.extend(marker.position),maps[i].fitBounds(bounds)),self.addMarkerEvents(marker,map),self.markers.push(marker)}},self.addMarkerEvents=function(marker,map){self.is_single_entry||(google.maps.event.addListener(marker,"click",self.markerOnClick(marker)),google.maps.event.addListener(marker,"mouseover",self.markerOnOver(marker)),google.maps.event.addListener(marker,"mouseout",self.markerOnMouseOut(marker)),google.maps.event.addListener(map,"click",function(){infowindow.close()}))},self.markerOnClick=function(marker){return function(){var content=self.getInfowindowContent(marker.content);content?(infowindow.setContent(content),infowindow.open(marker.map,marker)):(infowindow.close(),window.open(marker.url,self.marker_link_target))}},self.getInfowindowContent=function(content){if(!self.infowindow.no_empty)return content;var $content=$(content);return $content.find('img[src=""]').remove().end().addClass(function(){return 0===$content.find("img").length?"gv-infowindow-no-image":void 0}).find("a.gv-infowindow-entry-link:not([allow-empty]):empty").text(self.infowindow.empty_text),$content.prop("outerHTML")},self.markerOnOver=function(marker){return function(){$("#gv_map_"+marker.entryId).addClass("gv-highlight-entry")}},self.markerOnMouseOut=function(marker){return function(){$("#gv_map_"+marker.entryId).removeClass("gv-highlight-entry")}},self.initAnimateMarkers=function(){self.is_single_entry||""===self.icon_bounce||$(".gv-map-view").on("mouseenter",self.animateMarker)},self.animateMarker=function(e){var id=this.id.replace("gv_map_","");self.markers.forEach(self.triggerAnimationMarker,id)},self.triggerAnimationMarker=function(marker,i,array){if(marker.entryId===this){if(marker.animating)return;marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(self.stopAnimationMarker,750,marker)}},self.stopAnimationMarker=function(marker,i){marker.setAnimation(null)},self.prepareStickyCanvas=function(){self.mapStickyContainer=$(".gv-map-sticky-container");var windowHeight=$(window).height(),doubleCanvasHeight=2*self.mapStickyContainer.height();doubleCanvasHeight>windowHeight&&$(".gv-map-canvas").height(windowHeight/2)},self.initOffset=function(){self.mapOffset=self.mapStickyContainer.offset().top},self.setScroll=function(){self.didScroll=!0},self.startScrollCheck=function(){self.mapStickyContainer.length>0&&($(window).one("scroll",self.initOffset),setInterval(self.runOnScroll,250))},self.runOnScroll=function(){if(self.didScroll){self.didScroll=!1;var scroll=$(window).scrollTop(),canvasObj=self.mapStickyContainer.find("."+self.map_id_prefix),listObj=$(self.mapEntriesContainerClass),canvasWidth=canvasObj.width(),canvasHeight=canvasObj.height();scroll>=self.mapOffset?(canvasObj.width(canvasWidth),self.mapStickyContainer.addClass("gv-sticky"),"top"===self.template_layout&&listObj.css("margin-top",canvasHeight+"px")):(canvasObj.width("100%"),self.mapStickyContainer.removeClass("gv-sticky"),"top"===self.template_layout&&listObj.css("margin-top",""))}},self.initMobile=function(){if(!(self.mapStickyContainer.length<=0)){var viewPort=$(window).width();600>=viewPort&&self.mobileMapToTop()}},self.mobileMapToTop=function(){var parent=self.mapStickyContainer.parent(),grandPa=$(".gv-map-container");parent.hasClass("gv-grid-col-1-3")&&1===parent.index()&&parent.detach().prependTo(grandPa)},self.zoomControlOptions=function(){return{style:google.maps.ZoomControlStyle[self.MapOptions.zoomControlOptions.style],position:google.maps.ControlPosition[self.MapOptions.zoomControlOptions.position]}},$(self.init),$(window).scroll(self.setScroll)}(jQuery);